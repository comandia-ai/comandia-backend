{
  "name": "COMANDIA WhatsApp Handler v2 (with Supabase)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-webhook"
      },
      "name": "WhatsApp Webhook",
      "type": "n8n-nodes-base.webhook",
      "position": [250, 300]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst body = input.body || input;\n\nif (!body.entry) {\n  return [{ json: { skip: true, reason: 'No entry' } }];\n}\n\nconst changes = body.entry[0].changes[0];\nconst value = changes.value;\n\nif (!value.messages) {\n  return [{ json: { skip: true, reason: 'No messages' } }];\n}\n\nconst message = value.messages[0];\nconst contact = value.contacts[0];\n\nreturn [{\n  json: {\n    message_id: message.id,\n    from: message.from,\n    type: message.type,\n    text: message.text ? message.text.body : '',\n    customer_name: contact.profile.name,\n    customer_phone: contact.wa_id,\n    phone_number_id: value.metadata.phone_number_id\n  }\n}];"
      },
      "name": "Extract Message",
      "type": "n8n-nodes-base.code",
      "position": [450, 300]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "customers",
        "filters": {
          "conditions": [
            {
              "column": "phone",
              "operator": "eq",
              "value": "={{ $json.customer_phone }}"
            }
          ]
        },
        "limit": 1
      },
      "name": "Find Customer",
      "type": "n8n-nodes-base.supabase",
      "position": [650, 300]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst extractData = $('Extract Message').first().json;\n\n// Check if customer was found\nconst customerFound = input && input.id;\n\nreturn [{\n  json: {\n    customer_found: customerFound,\n    customer_id: customerFound ? input.id : null,\n    customer_name: customerFound ? input.name : extractData.customer_name,\n    customer_phone: extractData.customer_phone,\n    text: extractData.text,\n    message_id: extractData.message_id,\n    from: extractData.from,\n    phone_number_id: extractData.phone_number_id\n  }\n}];"
      },
      "name": "Merge Customer Data",
      "type": "n8n-nodes-base.code",
      "position": [850, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.customer_found }}",
              "value2": true
            }
          ]
        }
      },
      "name": "Customer Exists?",
      "type": "n8n-nodes-base.if",
      "position": [1050, 300]
    },
    {
      "parameters": {
        "operation": "insert",
        "tableId": "customers",
        "fieldsToSend": {
          "fieldValues": [
            {
              "fieldName": "name",
              "fieldValue": "={{ $json.customer_name }}"
            },
            {
              "fieldName": "phone",
              "fieldValue": "={{ $json.customer_phone }}"
            },
            {
              "fieldName": "whatsapp_id",
              "fieldValue": "={{ $json.from }}"
            },
            {
              "fieldName": "customer_type",
              "fieldValue": "new"
            },
            {
              "fieldName": "tenant_id",
              "fieldValue": "your-tenant-id-here"
            }
          ]
        }
      },
      "name": "Create Customer",
      "type": "n8n-nodes-base.supabase",
      "position": [1250, 400]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst prevData = $('Merge Customer Data').first().json;\n\nreturn [{\n  json: {\n    customer_id: input.id || prevData.customer_id,\n    customer_name: input.name || prevData.customer_name,\n    customer_phone: prevData.customer_phone,\n    text: prevData.text,\n    message_id: prevData.message_id,\n    phone_number_id: prevData.phone_number_id\n  }\n}];"
      },
      "name": "Prepare for AI",
      "type": "n8n-nodes-base.code",
      "position": [1450, 300]
    },
    {
      "parameters": {
        "model": "gpt-3.5-turbo",
        "messages": {
          "values": [
            {
              "content": "=Classify this WhatsApp message for a Colombian wholesale business.\n\nMessage: {{ $json.text }}\n\nCategories:\n- order: wants to place an order\n- greeting: saying hello\n- question: asking about products/prices\n- confirmation: confirming (s√≠, dale)\n- lo_de_siempre: wants usual order\n- other: none of above\n\nRespond JSON only: {\"intent\": \"category\", \"confidence\": 0.9}"
            }
          ]
        },
        "options": {
          "temperature": 0.3
        }
      },
      "name": "AI Classify Intent",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "position": [1650, 300]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst prevData = $('Prepare for AI').first().json;\nlet parsed;\n\ntry {\n  let content = '';\n  \n  if (response.output && response.output[0] && response.output[0].content) {\n    content = response.output[0].content[0].text || '';\n  } else if (response.message && response.message.content) {\n    content = response.message.content;\n  } else if (typeof response.text === 'string') {\n    content = response.text;\n  } else {\n    content = JSON.stringify(response);\n  }\n  \n  if (typeof content === 'string') {\n    const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      parsed = JSON.parse(jsonMatch[0]);\n    } else {\n      parsed = { intent: 'other', confidence: 0 };\n    }\n  } else {\n    parsed = { intent: 'other', confidence: 0 };\n  }\n} catch(e) {\n  parsed = { intent: 'other', confidence: 0, error: e.message };\n}\n\nreturn [{ \n  json: {\n    ...parsed,\n    ...prevData\n  }\n}];"
      },
      "name": "Parse AI Response",
      "type": "n8n-nodes-base.code",
      "position": [1850, 300]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "outputKey": "Order",
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "order",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "outputKey": "Greeting",
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "greeting",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "outputKey": "Lo de Siempre",
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "lo_de_siempre",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            }
          ]
        },
        "fallbackOutput": "Other"
      },
      "name": "Route by Intent",
      "type": "n8n-nodes-base.switch",
      "position": [2050, 300]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\n\nconst message = `¬°Gracias por tu pedido! üì¶\n\nRecib√≠ tu mensaje:\n\"${input.text || ''}\"\n\nPor favor confirma los productos y cantidades.\n\n¬øConfirmas este pedido? Responde *S√ç* o *NO*`;\n\nreturn [{\n  json: {\n    to: input.customer_phone,\n    message: message,\n    phone_number_id: input.phone_number_id,\n    customer_id: input.customer_id,\n    intent: 'order'\n  }\n}];"
      },
      "name": "Generate Order Response",
      "type": "n8n-nodes-base.code",
      "position": [2250, 200]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\n\nconst hour = new Date().getHours();\nlet greeting;\n\nif (hour < 12) {\n  greeting = '¬°Buenos d√≠as';\n} else if (hour < 18) {\n  greeting = '¬°Buenas tardes';\n} else {\n  greeting = '¬°Buenas noches';\n}\n\nconst message = `${greeting}! üëã\n\n¬øEn qu√© puedo ayudarte hoy?\n\nüì¶ *Hacer pedido* - escribe los productos\nüîÑ *Lo de siempre* - repite tu √∫ltimo pedido\n‚ùì *Preguntas* - consulta precios o disponibilidad\n\n¬°Estoy aqu√≠ para ayudarte!`;\n\nreturn [{\n  json: {\n    to: input.customer_phone,\n    message: message,\n    phone_number_id: input.phone_number_id,\n    customer_id: input.customer_id,\n    intent: 'greeting'\n  }\n}];"
      },
      "name": "Generate Greeting Response",
      "type": "n8n-nodes-base.code",
      "position": [2250, 350]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\n\nconst message = `¬°Perfecto! üîÑ\n\nVoy a preparar tu pedido de siempre.\n\nTe confirmo en un momento con el detalle y el total.\n\n¬øNecesitas agregar algo m√°s?`;\n\nreturn [{\n  json: {\n    to: input.customer_phone,\n    message: message,\n    phone_number_id: input.phone_number_id,\n    customer_id: input.customer_id,\n    intent: 'lo_de_siempre'\n  }\n}];"
      },
      "name": "Generate Repeat Order Response",
      "type": "n8n-nodes-base.code",
      "position": [2250, 500]
    },
    {
      "parameters": {
        "operation": "insert",
        "tableId": "whatsapp_messages",
        "fieldsToSend": {
          "fieldValues": [
            {
              "fieldName": "tenant_id",
              "fieldValue": "your-tenant-id-here"
            },
            {
              "fieldName": "message_id",
              "fieldValue": "={{ $('Extract Message').first().json.message_id }}"
            },
            {
              "fieldName": "direction",
              "fieldValue": "inbound"
            },
            {
              "fieldName": "message_type",
              "fieldValue": "text"
            },
            {
              "fieldName": "content",
              "fieldValue": "={{ $('Extract Message').first().json.text }}"
            },
            {
              "fieldName": "status",
              "fieldValue": "received"
            }
          ]
        }
      },
      "name": "Save Message",
      "type": "n8n-nodes-base.supabase",
      "position": [2450, 350]
    }
  ],
  "connections": {
    "WhatsApp Webhook": {
      "main": [[{"node": "Extract Message", "type": "main", "index": 0}]]
    },
    "Extract Message": {
      "main": [[{"node": "Find Customer", "type": "main", "index": 0}]]
    },
    "Find Customer": {
      "main": [[{"node": "Merge Customer Data", "type": "main", "index": 0}]]
    },
    "Merge Customer Data": {
      "main": [[{"node": "Customer Exists?", "type": "main", "index": 0}]]
    },
    "Customer Exists?": {
      "main": [
        [{"node": "Prepare for AI", "type": "main", "index": 0}],
        [{"node": "Create Customer", "type": "main", "index": 0}]
      ]
    },
    "Create Customer": {
      "main": [[{"node": "Prepare for AI", "type": "main", "index": 0}]]
    },
    "Prepare for AI": {
      "main": [[{"node": "AI Classify Intent", "type": "main", "index": 0}]]
    },
    "AI Classify Intent": {
      "main": [[{"node": "Parse AI Response", "type": "main", "index": 0}]]
    },
    "Parse AI Response": {
      "main": [[{"node": "Route by Intent", "type": "main", "index": 0}]]
    },
    "Route by Intent": {
      "main": [
        [{"node": "Generate Order Response", "type": "main", "index": 0}],
        [{"node": "Generate Greeting Response", "type": "main", "index": 0}],
        [{"node": "Generate Repeat Order Response", "type": "main", "index": 0}]
      ]
    },
    "Generate Order Response": {
      "main": [[{"node": "Save Message", "type": "main", "index": 0}]]
    },
    "Generate Greeting Response": {
      "main": [[{"node": "Save Message", "type": "main", "index": 0}]]
    },
    "Generate Repeat Order Response": {
      "main": [[{"node": "Save Message", "type": "main", "index": 0}]]
    }
  }
}
